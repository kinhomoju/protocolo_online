{% extends 'base_generic.html' %}
{% load static %}

{% block title %}SisPro - Dashboard Master{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Cabeçalho do dashboard -->
    <div class="text-center mb-4">
        <h2>Bem-vindo, {{ user.nome }}</h2>
    </div>

    <!-- Exibição de mensagens -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <!-- Botões de navegação -->
    <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
        <a href="{% url 'usuarios:aprovar_usuarios' %}" 
           class="btn {% if cadastros_pendentes > 0 %}btn-warning{% else %}btn-secondary{% endif %} btn-lg"
           title="{% if cadastros_pendentes > 0 %}Existem cadastros pendentes para aprovação{% else %}Nenhum cadastro pendente{% endif %}">
            Aprovar Usuários
            {% if cadastros_pendentes > 0 %}
                <span class="badge bg-danger ms-2">{{ cadastros_pendentes }}</span>
            {% endif %}
        </a>
        <a href="{% url 'usuarios:excluir_usuarios' %}" class="btn btn-secondary btn-lg">Excluir Usuários</a>
        <a href="{% url 'usuarios:logout' %}" class="btn btn-danger btn-lg">Logout</a>
    </div>

    <div class="row">
        <!-- Pesquisa de Usuários -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">Pesquisa de Usuários</div>
                <div class="card-body">
                    <form method="get" action="{% url 'usuarios:pesquisa_usuarios' %}">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Nome, username ou email">
                            <button type="submit" class="btn btn-primary">Pesquisar</button>
                        </div>
                    </form>
                    {% if usuarios_pesquisa %}
                        <table class="table table-striped mt-3">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Usuário</th>
                                    <th>Email</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for usuario in usuarios_pesquisa %}
                                <tr>
                                    <td>{{ usuario.nome }}</td>
                                    <td>{{ usuario.username }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmarExclusao{{ usuario.id }}">
                                            Excluir
                                        </button>
                                        {% include 'includes/_modal_confirmacao_exclusao.html' with item_id=usuario.id item_nome=usuario.nome item_tipo='usuario' excluir_url='usuarios:excluir_usuario' %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% include 'includes/_paginacao.html' with page_obj=usuarios_pesquisa %}
                    {% elif request.GET.q %}
                        <p class="mt-3 text-muted">Nenhum usuário encontrado.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pesquisa de Protocolos -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">Pesquisa de Protocolos</div>
                <div class="card-body">
                    <form method="get" action="{% url 'protocolos:pesquisa_protocolos' %}">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" placeholder="Número ou descrição">
                            <button type="submit" class="btn btn-primary">Pesquisar</button>
                        </div>
                    </form>
                    {% if protocolos_pesquisa %}
                        <table class="table table-striped mt-3">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Descrição</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for protocolo in protocolos_pesquisa %}
                                <tr>
                                    <td>{{ protocolo.numero }}</td>
                                    <td>{{ protocolo.descricao }}</td>
                                    <td>{{ protocolo.status }}</td>
                                    <td>{{ protocolo.data_criacao|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <div class="d-flex gap-2">
                                            {% if protocolo.status == 'pendente' %}
                                                <a href="{% url 'protocolos:editar_protocolo' protocolo.id %}" class="btn btn-warning btn-sm">Editar</a>
                                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmarExclusao{{ protocolo.id }}">
                                                    Excluir
                                                </button>
                                                {% include 'usuarios/_modal_confirmacao_exclusao.html' with item_id=protocolo.id item_nome=protocolo.numero item_tipo='protocolo' excluir_url='protocolos:excluir_protocolo' %}
                                            {% else %}
                                                <span class="text-muted">Ação indisponível</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% include 'includes/_paginacao.html' with page_obj=protocolos_pesquisa %}
                    {% elif request.GET.q %}
                        <p class="mt-3 text-muted">Nenhum protocolo encontrado.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Últimos cadastros -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">Últimos 10 Usuários Cadastrados</div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for usuario in ultimos_usuarios %}
                        <li class="list-group-item">{{ usuario.nome }} - {{ usuario.username }} - {{ usuario.email }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">Últimos 10 Protocolos Cadastrados</div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for protocolo in ultimos_protocolos %}
                        <li class="list-group-item">{{ protocolo.numero }} - {{ protocolo.descricao }} - {{ protocolo.data_criacao|date:"d/m/Y H:i" }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
